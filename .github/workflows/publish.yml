name: Publish the new version of the course to the API
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # the AMS key generated by an admin
  API_KEY: "${{ secrets.API_KEY }}"
  # e.g. https://api.kibo.school or https://develop.api.kibo.school
  API_URL: "${{ secrets.DEPLOY_URL }}"
  REPO_PATH: "${{ github.repository }}"
jobs:
  deploy:
    name: publish
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: vars
        run: |
          echo $API_URL
          echo $REPO_PATH
          echo ${{ github.repository }}
          echo "{\"github_path\": \"$REPO_PATH\"}"
      - name: publish
        run: |
          curl --fail-with-body --request POST \
          --url "$API_URL/api/latest/courses/update" \
          -H "Authorization: SharedKey $API_KEY" \
          -H "Content-Type: application/json" \
          --data "{\"github_path\": \"$REPO_PATH\"}"